# HomeAssistant KNX Automatic Import

HomeAssistantKNXAutomaticImport is a script tool to create configuration file for the [Home Assistant KNX integration](https://www.home-assistant.io/integrations/knx/).

## Warning

To operate correctly, HomeAssistantKNXAutomaticImport requires your KNX project to respect certain rules:
* functions expected to be identified need to be part of the Building tree
Note: the jeedom knx importer is able to read the knx project from different perspectives, not this tool. That could be a future enhancement.
* function name needs to contain specific keys to be recognized. See below.
* group address name needs to contain specific keys to be recognized. See below.

## Description

HomeAssistantKNXAutomaticImport is analyzing a knx project from ETS and generating configurations file for [Home Assistant KNX integration](https://www.home-assistant.io/integrations/knx/).
Refer to [Home Assistant KNX integration](https://www.home-assistant.io/integrations/knx/) home page for detail about installation of the knx integration in home assistant.\
Generated configuration files are generated to the expected yaml format to be directly interpreted by the [Home Assistant KNX integration](https://www.home-assistant.io/integrations/knx/).\
HomeAssistantKNXAutomaticImport may generate more than one yaml files to have more flexibility and visibility on your configuration.
To support multiple configuration files, it is recommended to use the [packages](https://www.home-assistant.io/docs/configuration/packages/) configuration approach.
A directory can be created in the root config folder to store all yaml files generated by HomeAssistantKNXAutomaticImport and declared in the main `configuration.yaml` as follow:
```
homeassistant:
  packages: !include_dir_named knx
```


## Usage

Type `HomeAssistantKnxAutomaticImport.py --help` for detail.

## Concepts

### Overview

HomeAssistantKNXAutomaticImport is using the Buildings Tree to analyze the KNX project.
It browses the tree and when a function is found, HomeAssistantKNXAutomaticImport try to analyze it to create a KNX integration entity.\
A function is identified when it contains a certain key.
The key helps also to identify the [Home Assistant KNX integration](https://www.home-assistant.io/integrations/knx/) entity type.
When the entity type is identified, HomeAssistantKNXAutomaticImport search for elements to generate configuration variables.
Searched elements depends on the configuration variable and are described in the next chapters.
When all entities have been generated, HomeAssistantKNXAutomaticImport generates the yaml files. One yaml files is generated per locations (building, room,...) containing functions.

### Group Address configuration variable (GA)

The Group Address is a configuration variable that identifies a group address to write or read on the bus.\
When HomeAssistantKNXAutomaticImport searches for a group address it is browsing the group addresses contained in the function.
The Group Address is identified when it contains a certain key.

### Response to Read configuration variable (RtR)

The Response to Read is a configuration variable that identifies if an entity will answer to a read request.\
When HomeAssistantKNXAutomaticImport searches for a Response to Read, it is analyzing the read KNX flag of the objects associated to the group address associated to the Response to Read.
If one is found to be active, the Response to Read configuration is set to True, False otherwise.

### Value Type configuration variable (VT)

The Value Type is a configuration variable that identifies the value type managed by an entity.
When HomeAssistantKNXAutomaticImport searches for a Value Type, it is analyzing the data type of the group address associated to the Value.

## Roundtrip

### Overview

HomeAssistantKNXAutomaticImport is able to make roundtrip on the yaml files.\
Indeed, as all configuration elements are not available in the knx project, the user will have to complete the generated yaml file with addition information.\
In order not to lose the added configuration in case of an update,
HomeAssistantKNXAutomaticImport can read the existing yaml configuration files,
complete them and generate new configuration files preserving elements that are not part of the knx project.\

### Comments

HomeAssistantKNXAutomaticImport manages comments in yaml for the roundtrip. Meaning comments are preserved.\
HomeAssistantKNXAutomaticImport also generates private comments used to stored data that will be useful for a roundtrip.
Without these data, it will not be able to read correctly the yaml files and generating them again correctly.\
<span style="color:red">
Private comments shall not be touched.\
</span>
They are identified by a `DO NOT REMOVE` as shown in the example below:\
```
expose:
  - type: datetime  # !DO NOT REMOVE!Expose D&T
    address: "21/0/0"
```

